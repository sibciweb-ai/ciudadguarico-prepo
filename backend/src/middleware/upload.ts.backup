import multer from 'multer';
import path from 'path';
import fs from 'fs';
import sharp from 'sharp';

// Directorio de uploads local (sirve archivos estáticos desde app.ts con /uploads)
const uploadsDir = path.join(__dirname, '../../uploads');
if (!fs.existsSync(uploadsDir)) {
  fs.mkdirSync(uploadsDir, { recursive: true });
}

// Almacenamiento local en disco con conversión a WebP
const diskStorage = multer.diskStorage({
  destination: (_req, _file, cb) => {
    cb(null, uploadsDir);
  },
  filename: (_req, file, cb) => {
    const timestamp = Date.now();
    const nameWithoutExt = path.parse(file.originalname).name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
    // Siempre guardar como .webp
    cb(null, `${timestamp}-${nameWithoutExt}.webp`);
  }
});

// Filtro de archivos mejorado
const fileFilter = (_req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
  const allowedMimes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
  if (allowedMimes.includes(file.mimetype)) {
    cb(null, true);
  } else {
    cb(new Error('Tipo de archivo no válido. Solo se permiten imágenes JPG, PNG, GIF y WebP.'));
  }
};

// Middleware personalizado para convertir imágenes a WebP
export const convertToWebP = (req: any, res: any, next: any) => {
  if (!req.file) {
    return next();
  }

  const inputPath = req.file.path;
  const timestamp = Date.now();
  const nameWithoutExt = path.parse(req.file.originalname).name.replace(/[^a-zA-Z0-9.\-_]/g, '_');
  const outputFilename = `${timestamp}-${nameWithoutExt}.webp`;
  const outputPath = path.join(uploadsDir, outputFilename);

  // Convertir imagen a WebP usando Sharp
  sharp(inputPath)
    .webp({ quality: 85, effort: 4 }) // Calidad 85% con optimización nivel 4
    .toFile(outputPath)
    .then(() => {
      // Eliminar archivo original si no es WebP
      if (req.file.mimetype !== 'image/webp') {
        fs.unlink(inputPath, (err) => {
          if (err) console.warn('Error eliminando archivo temporal:', err);
        });
      }

      // Actualizar información del archivo en req.file
      req.file.filename = outputFilename;
      req.file.path = outputPath;
      req.file.mimetype = 'image/webp';

      next();
    })
    .catch((error) => {
      console.error('Error convirtiendo imagen a WebP:', error);
      // Si falla la conversión, continuar con el archivo original
      next();
    });
};

// Configuración de multer para noticias con almacenamiento local
export const upload = multer({
  storage: diskStorage,
  fileFilter: fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});

// Configuración de multer para contenido destacado con almacenamiento local
export const uploadContenido = multer({
  storage: diskStorage,
  fileFilter: fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024 // 10MB
  }
});
